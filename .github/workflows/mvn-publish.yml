name: Publish to maven
on:
  workflow_dispatch:
    inputs:
      maven_version:
        description: 'Maven version to release'
        required: true
      vault_version:
        description: 'Vault version to release'
        required: true

jobs:
    build-n-publish:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - uses: actions/checkout@v3
        - name: Set up Maven Central Repository
          uses: actions/setup-java@v3
          with:
            java-version: '19'
            distribution: 'zulu'
            cache: maven
            server-id: ossrh
            server-username: MAVEN_USERNAME
            server-password: MAVEN_PASSWORD

        - name: Update version of sdk
          run: |
            # Updating version of client
            source VERSION
            cd sdk/client
            sed -i "s/<version>$MAVEN_VERSION-SNAPSHOT<\/version>/<version>${{ inputs.maven_version }}-SNAPSHOT<\/version>/g" pom.xml

        - name: Update VERSION file
          run: |
            echo -e "VAULT_VERSION=${{ inputs.vault_version }}\nMAVEN_VERSION=${{ inputs.maven_version }}" > VERSION 

        - name: Commit change and push
          run: |
            git config --global user.email "cicd@piiano.com"
            git config --global user.name "Github Actions"
            git add .
            git commit -m "Update client maven version to ${{ inputs.maven_version }}"
            git push

        - name: Build and publish client
          if : success()
          run: |
            cd sdk/client
            mvn --batch-mode deploy
          env:
            MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
            MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
