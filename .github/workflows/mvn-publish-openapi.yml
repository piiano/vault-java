name: Publish generated openapi to maven
on:
  workflow_call:
    inputs:
      maven_version:
        type: string
        description: 'Maven version to release'
        required: true
      vault_version:
        type: string
        description: 'Vault version to release'
        required: true
    secrets:
      OSSRH_USERNAME:
        description: 'OSSRH Username'
        required: true
      OSSRH_TOKEN:
        description: 'OSSRH Token'
        required: true

  workflow_dispatch:
    inputs:
      maven_version:
        description: 'Maven version to release'
        required: true
      vault_version:
        description: 'Vault version to release'
        required: true

jobs:
  build-n-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install java
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'zulu'
          cache: maven
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD

      - name: Generate openapi
        run: |
          cd sdk
          # update the generator config file with the required version
          sed -i "s/$MAVEN_VERSION-SNAPSHOT/${{ inputs.maven_version }}-SNAPSHOT/g" config.yaml
          make generate-openapi
          sed -i "s/<build>/    <distributionManagement>\n    <snapshotRepository>\n    <id>ossrh<\/id>\n   <url>https:\/\/s01.oss.sonatype.org\/content\/repositories\/snapshots<\/url>\n    <\/snapshotRepository>\n    <\/distributionManagement>\n\n     <build>/g" openapi/pom.xml
          sed -i "s/<plugins>/<plugins>\n    <plugin>\n    <groupId>org.sonatype.plugins<\/groupId>\n    <artifactId>nexus-staging-maven-plugin<\/artifactId>\n    <version>1.6.7<\/version>\n    <extensions>true<\/extensions>\n    <configuration>\n      <serverId>ossrh<\/serverId>\n      <nexusUrl>https:\/\/s01.oss.sonatype.org\/<\/nexusUrl>\n      <autoReleaseAfterClose>true<\/autoReleaseAfterClose>\n    <\/configuration>\n  <\/plugin>\n/g" openapi/pom.xml

      - name: Build and publish openapi
        if: success()
        run: |
          cd sdk/openapi
          mvn --batch-mode deploy -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
